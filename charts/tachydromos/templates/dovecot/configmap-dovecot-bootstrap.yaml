apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tachydromos.fullname" . }}-dovecot-bootstrap
  labels:
    {{- include "tachydromos.labels" . | nindent 4 }}
data:
  bootstrap.sh: |
    #!/usr/bin/env sh

    set -o errexit
    set -o nounset
    set -o pipefail

    cp -LR /etc/dovecot/* /mnt/configvolume/
    export LDAP_BINDDN="cn=${LDAP_BINDDN_USERNAME},${LDAP_ROOT}"
    find /mnt/configmap -type f -iname '*.conf' -exec sh -c "envsubst < {} > /mnt/configvolume/\`basename {}\`" \;
    find /mnt/configmap-confd -type f -iname '*.conf' -exec sh -c "envsubst < {} > /mnt/configvolume/conf.d/\`basename {}\`" \;
    mkdir -p /mnt/data/sieve/global && chmod 0700 /mnt/data/sieve/global
    find /mnt/configmap-sieve -type f -iname '*.sh' -exec sh -c "envsubst < {} > /mnt/data/sieve/global/\`basename {}\` && chmod 0700 /mnt/data/sieve/global/\`basename {}\`" \;
    find /mnt/configmap-sieve -type f -iname '*.sieve' -exec sh -c "cp {} /mnt/data/sieve/global/\`basename {}\` && chmod 0600 /mnt/data/sieve/global/\`basename {}\`" \;
    chown -R vmail:vmail /mnt/data/sieve
    find /mnt/configmap-msmtp -type f -exec sh -c "envsubst < {} > /mnt/data/\`basename {}\`" \;
