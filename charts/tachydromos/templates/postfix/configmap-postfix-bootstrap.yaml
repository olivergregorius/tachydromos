apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tachydromos.fullname" . }}-postfix-bootstrap
  labels:
    {{- include "tachydromos.labels" . | nindent 4 }}
data:
  bootstrap.sh: |
    #!/usr/bin/env sh

    set -o errexit
    set -o nounset
    set -o pipefail

    cp -LR /etc/postfix/* /mnt/configvolume/
    cp -LR /mnt/configmap/* /mnt/configvolume/
    mkdir /mnt/configvolume/ldap
    export LDAP_BINDDN="cn=${LDAP_BINDDN_USERNAME},${LDAP_ROOT}"
    find /mnt/secret -type f -iname '*.cf' -exec sh -c "envsubst < {} > /mnt/configvolume/ldap/\`basename {}\`" \;
    postmap /mnt/configvolume/helo_access
    postmap /mnt/configvolume/postscreen_access
    postmap /mnt/configvolume/without_ptr
